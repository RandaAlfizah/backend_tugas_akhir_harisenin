import { classes } from '@automapper/classes';
import { defaultStrategyInitializerOptions } from '@automapper/core';

function sequelize(options = defaultStrategyInitializerOptions) {
  const mergedOptions = {
    ...defaultStrategyInitializerOptions,
    destinationConstructor: (_, destinationIdentifier) => {
      if ('sequelize' in destinationIdentifier) {
        return destinationIdentifier.build();
      }
      return new destinationIdentifier();
    },
    ...options
  };
  if (mergedOptions.preMap === defaultStrategyInitializerOptions.preMap) {
    mergedOptions.preMap = source => {
      if (source.get) {
        return source.get();
      }
      return source;
    };
  }
  return classes(mergedOptions);
}

export { sequelize };
